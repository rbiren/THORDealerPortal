// Prisma Schema for THORDealerPortal
// Using SQLite for local development - swap to PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          String    @default("dealer_user") // super_admin, admin, dealer_admin, dealer_user, readonly
  status        String    @default("active") // active, inactive, pending, suspended
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?

  dealerId      String?
  dealer        Dealer?   @relation(fields: [dealerId], references: [id])

  sessions      Session[]
  notifications Notification[]
  auditLogs     AuditLog[]
  orderNotes    OrderNote[]

  // Warranty relations
  warrantyClaimsSubmitted WarrantyClaim[] @relation("WarrantySubmitter")
  warrantyClaimsAssigned  WarrantyClaim[] @relation("WarrantyAssignee")
  warrantyClaimNotes      WarrantyClaimNote[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([dealerId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordReset {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([email])
}

// ============================================================================
// DEALERS
// ============================================================================

model Dealer {
  id              String   @id @default(cuid())
  code            String   @unique // Dealer code (e.g., "DLR001")
  name            String
  status          String   @default("pending") // active, pending, suspended, inactive
  tier            String   @default("bronze") // platinum, gold, silver, bronze

  // Business info
  ein             String?  // Employer Identification Number
  licenseNumber   String?
  insurancePolicy String?

  // Parent dealer for hierarchy
  parentDealerId  String?
  parentDealer    Dealer?  @relation("DealerHierarchy", fields: [parentDealerId], references: [id])
  childDealers    Dealer[] @relation("DealerHierarchy")

  users           User[]
  contacts        DealerContact[]
  addresses       DealerAddress[]
  carts           Cart[]
  orders          Order[]
  documents       Document[]
  forecastConfig  ForecastConfig?
  invoices        Invoice[]
  warrantyClaims  WarrantyClaim[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([tier])
}

model DealerContact {
  id        String  @id @default(cuid())
  dealerId  String
  dealer    Dealer  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  type      String  // primary, billing, shipping, support
  name      String
  email     String
  phone     String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealerId])
}

model DealerAddress {
  id        String  @id @default(cuid())
  dealerId  String
  dealer    Dealer  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  type      String  // billing, shipping, physical
  street    String
  street2   String?
  city      String
  state     String
  zipCode   String
  country   String  @default("US")
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealerId])
}

// ============================================================================
// PRODUCTS & INVENTORY
// ============================================================================

model ProductCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
}

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?

  categoryId  String?
  category    ProductCategory? @relation(fields: [categoryId], references: [id])

  price       Float    // Base price
  costPrice   Float?   // Cost for margin calculation
  status      String   @default("active") // active, discontinued, draft

  // Specifications stored as JSON string (SQLite doesn't have native JSON)
  specifications String? // JSON string

  images          ProductImage[]
  inventory       Inventory[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  demandForecasts DemandForecast[]
  suggestedOrders SuggestedOrder[]
  warrantyClaims  WarrantyClaim[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sku])
  @@index([categoryId])
  @@index([status])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  altText   String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([productId])
}

model InventoryLocation {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  type      String   // warehouse, store, distribution_center
  address   String?
  isActive  Boolean  @default(true)

  inventory Inventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  locationId  String
  location    InventoryLocation @relation(fields: [locationId], references: [id])

  quantity    Int      @default(0)
  reserved    Int      @default(0) // Reserved for pending orders
  lowStockThreshold Int @default(10)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

// ============================================================================
// SHOPPING CART
// ============================================================================

model Cart {
  id        String   @id @default(cuid())
  dealerId  String
  dealer    Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  userId    String?  // Optional - which user created the cart
  name      String?  // For saved carts
  isSaved   Boolean  @default(false) // true for saved carts, false for active cart

  items     CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealerId])
  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

// ============================================================================
// ORDERS
// ============================================================================

model Order {
  id            String   @id @default(cuid())
  orderNumber   String   @unique
  dealerId      String
  dealer        Dealer   @relation(fields: [dealerId], references: [id])

  status        String   @default("draft") // draft, submitted, confirmed, processing, shipped, delivered, cancelled

  // Pricing
  subtotal      Float    @default(0)
  taxAmount     Float    @default(0)
  shippingAmount Float   @default(0)
  totalAmount   Float    @default(0)

  // Addresses (stored as JSON strings for flexibility)
  shippingAddress String? // JSON string
  billingAddress  String? // JSON string

  // Tracking
  poNumber      String?  // Customer's PO number
  notes         String?

  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  invoices      Invoice[]
  orderNotes    OrderNote[]

  submittedAt   DateTime?
  confirmedAt   DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  cancelledAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderNumber])
  @@index([dealerId])
  @@index([status])
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id])

  quantity    Int
  unitPrice   Float
  totalPrice  Float

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
}

model OrderStatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    String
  note      String?
  changedBy String?  // User ID who made the change

  createdAt DateTime @default(now())

  @@index([orderId])
}

model OrderNote {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  content    String
  isInternal Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id              String    @id @default(cuid())
  invoiceNumber   String    @unique
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  status          String    @default("draft") // draft, sent, paid, overdue, cancelled

  // Amounts
  subtotal        Float     @default(0)
  taxAmount       Float     @default(0)
  shippingAmount  Float     @default(0)
  totalAmount     Float     @default(0)

  // Dates
  dueDate         DateTime?
  paidDate        DateTime?

  // Details (stored as JSON)
  items           String?   // JSON array of line items
  billingAddress  String?   // JSON object
  shippingAddress String?   // JSON object
  paymentTerms    String    @default("Net 30")
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([invoiceNumber])
  @@index([orderId])
  @@index([dealerId])
  @@index([status])
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model Document {
  id          String   @id @default(cuid())
  dealerId    String?
  dealer      Dealer?  @relation(fields: [dealerId], references: [id])

  name        String
  category    String   // contract, marketing, compliance, training, product_spec
  mimeType    String
  size        Int      // File size in bytes
  url         String   // S3 URL or local path

  version     Int      @default(1)
  isPublic    Boolean  @default(false)

  expiresAt   DateTime?
  uploadedBy  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([dealerId])
  @@index([category])
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String    // order_update, low_stock, document_expiry, system
  title     String
  body      String
  data      String?   // JSON string for additional data

  readAt    DateTime?

  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([type])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  action      String   // create, update, delete, login, logout
  entityType  String   // User, Dealer, Order, Product, etc.
  entityId    String?

  // Changes stored as JSON string
  oldValues   String?  // JSON string
  newValues   String?  // JSON string

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================================================
// INVENTORY FORECASTING
// ============================================================================

model ForecastConfig {
  id                  String   @id @default(cuid())
  dealerId            String
  dealer              Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  // Forecasting parameters
  forecastHorizon     Int      @default(18) // Months to forecast ahead
  historyPeriod       Int      @default(24) // Months of history to analyze
  confidenceLevel     Float    @default(0.95) // 95% confidence interval

  // Seasonal adjustments
  useSeasonality      Boolean  @default(true)
  seasonalityType     String   @default("multiplicative") // additive, multiplicative

  // Safety stock settings
  safetyStockDays     Int      @default(14) // Days of safety stock
  leadTimeDays        Int      @default(7)  // Average lead time for orders

  // Reorder settings
  reorderPointMethod  String   @default("dynamic") // fixed, dynamic, min_max
  minOrderQuantity    Int      @default(1)
  orderMultiple       Int      @default(1) // Order in multiples of this

  // Market factors
  marketGrowthRate    Float    @default(0) // Annual market growth %
  localMarketFactor   Float    @default(1.0) // Local market adjustment

  isActive            Boolean  @default(true)
  lastCalculatedAt    DateTime?

  demandForecasts     DemandForecast[]
  suggestedOrders     SuggestedOrder[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([dealerId])
  @@index([dealerId])
}

model DemandForecast {
  id              String   @id @default(cuid())
  forecastConfigId String
  forecastConfig  ForecastConfig @relation(fields: [forecastConfigId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Period information
  periodStart     DateTime // Start of forecast period
  periodEnd       DateTime // End of forecast period
  periodType      String   @default("month") // week, month, quarter

  // Forecast values
  forecastedDemand    Float   // Expected demand quantity
  lowerBound          Float   // Lower confidence bound
  upperBound          Float   // Upper confidence bound

  // Historical comparison
  historicalAverage   Float?  // Average from same period in history
  yearOverYearChange  Float?  // % change vs same period last year

  // Trend and seasonality components
  trendComponent      Float?  // Trend contribution
  seasonalComponent   Float?  // Seasonal contribution

  // Accuracy (filled in after actuals are known)
  actualDemand        Float?  // Actual demand (updated later)
  forecastError       Float?  // % error = (actual - forecast) / actual

  // Metadata
  modelVersion        String  @default("v1.0")
  calculatedAt        DateTime @default(now())

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([forecastConfigId, productId, periodStart])
  @@index([forecastConfigId])
  @@index([productId])
  @@index([periodStart])
}

model SuggestedOrder {
  id              String   @id @default(cuid())
  forecastConfigId String
  forecastConfig  ForecastConfig @relation(fields: [forecastConfigId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Order timing
  suggestedOrderDate  DateTime // When to place the order
  expectedDeliveryDate DateTime // When inventory will arrive

  // Order quantities
  suggestedQuantity   Int     // Recommended order quantity
  minimumQuantity     Int     // Minimum to maintain service level
  economicOrderQty    Int?    // EOQ if calculated

  // Inventory projections
  currentStock        Int     // Stock at time of calculation
  projectedStock      Int     // Stock at order date (before order)
  projectedDemand     Int     // Expected demand until next order

  // Financial
  estimatedCost       Float?  // Estimated order cost
  estimatedValue      Float?  // Retail value of order

  // Urgency and status
  priority            String  @default("normal") // critical, high, normal, low
  status              String  @default("pending") // pending, accepted, ordered, skipped

  // Reasoning
  reasoning           String? // JSON: why this recommendation was made

  // Tracking
  acceptedAt          DateTime?
  orderedAt           DateTime?
  actualOrderId       String?  // Link to actual order if placed

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([forecastConfigId])
  @@index([productId])
  @@index([suggestedOrderDate])
  @@index([status])
}

model SeasonalPattern {
  id          String   @id @default(cuid())
  dealerId    String?  // null = global pattern
  productId   String?  // null = category-wide pattern
  categoryId  String?  // null = all categories

  // Pattern definition
  patternName String   // e.g., "Holiday Season", "Summer Peak"
  patternType String   @default("monthly") // weekly, monthly, quarterly

  // Seasonal factors (JSON array of 12 monthly factors or 52 weekly factors)
  // e.g., [0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.3, 1.1, 1.0, 0.9, 1.5] for monthly
  factors     String   // JSON array of seasonal multipliers

  // Validity
  validFrom   DateTime?
  validTo     DateTime?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([dealerId])
  @@index([productId])
  @@index([categoryId])
}

model MarketIndicator {
  id              String   @id @default(cuid())

  // Geographic scope
  region          String   // e.g., "Northeast", "CA", "90210"
  regionType      String   // state, zipcode, region, national

  // Indicator details
  indicatorName   String   // e.g., "Housing Starts", "Consumer Confidence"
  indicatorType   String   // economic, demographic, industry, weather

  // Time series data
  periodStart     DateTime
  periodEnd       DateTime
  value           Float
  previousValue   Float?
  percentChange   Float?

  // Impact assessment
  impactFactor    Float    @default(1.0) // Multiplier effect on demand
  confidence      Float    @default(0.8) // Confidence in the indicator

  // Source
  source          String?  // Data source
  sourceUrl       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([region, indicatorName, periodStart])
  @@index([region])
  @@index([indicatorType])
  @@index([periodStart])
}

// ============================================================================
// WARRANTY CLAIMS
// ============================================================================

model WarrantyClaim {
  id              String    @id @default(cuid())
  claimNumber     String    @unique // WC-2025-00001 format
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  submittedById   String
  submittedBy     User      @relation("WarrantySubmitter", fields: [submittedById], references: [id])
  assignedToId    String?
  assignedTo      User?     @relation("WarrantyAssignee", fields: [assignedToId], references: [id])

  // Status workflow: draft -> submitted -> under_review -> info_requested -> approved/denied/partial
  status          String    @default("draft")

  // Claim type
  claimType       String    // product_defect, shipping_damage, missing_parts, other

  // Product information
  productId       String?
  product         Product?  @relation(fields: [productId], references: [id])
  productName     String    // Store name even if product deleted
  serialNumber    String?
  modelNumber     String?
  purchaseDate    DateTime?
  installDate     DateTime?

  // Customer information (end user who experienced the issue)
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerAddress String?   // JSON string

  // Issue details
  issueDescription    String
  failureDate         DateTime?
  isUnderWarranty     Boolean   @default(true)

  // Resolution
  resolutionType      String?   // replacement, repair, credit, denial
  resolutionNotes     String?

  // Amounts
  laborHours          Float?
  laborRate           Float?
  partsAmount         Float     @default(0)
  laborAmount         Float     @default(0)
  shippingAmount      Float     @default(0)
  totalRequested      Float     @default(0)
  totalApproved       Float?

  // Tracking
  priority            String    @default("normal") // low, normal, high, urgent

  items               WarrantyClaimItem[]
  attachments         WarrantyClaimAttachment[]
  notes               WarrantyClaimNote[]
  statusHistory       WarrantyClaimStatusHistory[]

  submittedAt         DateTime?
  reviewedAt          DateTime?
  resolvedAt          DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([claimNumber])
  @@index([dealerId])
  @@index([status])
  @@index([submittedById])
  @@index([assignedToId])
  @@index([createdAt])
}

model WarrantyClaimItem {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  partNumber      String?
  partName        String
  quantity        Int       @default(1)
  unitCost        Float     @default(0)
  totalCost       Float     @default(0)

  issueType       String    // defective, damaged, missing, worn, other
  issueDescription String?

  // Resolution for this specific item
  approved        Boolean?
  approvedQty     Int?
  approvedAmount  Float?
  denialReason    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([claimId])
}

model WarrantyClaimAttachment {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  filename        String
  originalName    String
  mimeType        String
  size            Int       // bytes
  url             String    // Storage URL

  category        String    @default("photo") // photo, receipt, invoice, document, other
  description     String?

  uploadedById    String?

  createdAt       DateTime  @default(now())

  @@index([claimId])
}

model WarrantyClaimNote {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  content         String
  isInternal      Boolean   @default(false) // Internal notes only visible to manufacturer
  isSystemNote    Boolean   @default(false) // Auto-generated status change notes

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([claimId])
  @@index([userId])
}

model WarrantyClaimStatusHistory {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  fromStatus      String?
  toStatus        String
  changedById     String?
  note            String?

  createdAt       DateTime  @default(now())

  @@index([claimId])
  @@index([createdAt])
}
