// Prisma Schema for THORDealerPortal
// Using SQLite for local development - swap to PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          String    @default("dealer_user") // super_admin, admin, dealer_admin, dealer_user, readonly
  status        String    @default("active") // active, inactive, pending, suspended
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?

  dealerId      String?
  dealer        Dealer?   @relation(fields: [dealerId], references: [id])

  sessions      Session[]
  notifications Notification[]
  auditLogs     AuditLog[]
  orderNotes    OrderNote[]

  // Warranty relations
  warrantyClaimsSubmitted WarrantyClaim[] @relation("WarrantySubmitter")
  warrantyClaimsAssigned  WarrantyClaim[] @relation("WarrantyAssignee")
  warrantyClaimNotes      WarrantyClaimNote[]

  // Phase 8: Communication Hub
  ticketsSubmitted        SupportTicket[] @relation("TicketSubmitter")
  ticketsAssigned         SupportTicket[] @relation("TicketAssignee")
  ticketMessages          TicketMessage[]

  // Phase 8: Incentives
  incentiveClaimsSubmitted IncentiveClaim[]

  // Phase 8: Training
  trainingAssignments     TrainingAssignment[]
  courseProgress          CourseProgress[]
  certifications          Certification[]

  // Phase 8: Parts & Service
  partsOrders             PartsOrder[]
  bulletinAcknowledgments ServiceBulletinAcknowledgment[]

  // Phase 8: Marketing
  assetDownloads          MarketingAssetDownload[]

  // Phase 8: Community Forum
  forumPosts              ForumPost[] @relation("ForumPostAuthor")
  forumReplies            ForumReply[] @relation("ForumReplyAuthor")
  forumPostLikes          ForumPostLike[]
  forumReplyLikes         ForumReplyLike[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([dealerId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordReset {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([email])
}

// ============================================================================
// DEALERS
// ============================================================================

model Dealer {
  id              String   @id @default(cuid())
  code            String   @unique // Dealer code (e.g., "DLR001")
  name            String
  status          String   @default("pending") // active, pending, suspended, inactive
  tier            String   @default("bronze") // platinum, gold, silver, bronze

  // Business info
  ein             String?  // Employer Identification Number
  licenseNumber   String?
  insurancePolicy String?

  // Parent dealer for hierarchy
  parentDealerId  String?
  parentDealer    Dealer?  @relation("DealerHierarchy", fields: [parentDealerId], references: [id])
  childDealers    Dealer[] @relation("DealerHierarchy")

  users           User[]
  contacts        DealerContact[]
  addresses       DealerAddress[]
  carts           Cart[]
  orders          Order[]
  documents       Document[]
  forecastConfig  ForecastConfig?
  invoices        Invoice[]
  warrantyClaims  WarrantyClaim[]

  // Phase 8: Communication Hub
  supportTickets  SupportTicket[]

  // Phase 8: Incentives & Programs
  programEnrollments DealerProgramEnrollment[]
  rebateAccruals     RebateAccrual[]
  incentiveClaims    IncentiveClaim[]
  incentivePayouts   IncentivePayout[]

  // Phase 8: Training & Certification
  trainingAssignments TrainingAssignment[]
  certifications      Certification[]

  // Phase 8: Performance Scorecard
  scorecards          DealerScorecard[]
  performanceMetrics  PerformanceMetric[]
  salesTargets        SalesTarget[]

  // Phase 8: Parts & Service
  partsOrders             PartsOrder[]
  bulletinAcknowledgments ServiceBulletinAcknowledgment[]
  recallNotifications     RecallDealerNotification[]

  // Phase 8: Marketing Asset Library
  assetDownloads          MarketingAssetDownload[]

  // Phase 8: Community Forum
  forumPosts              ForumPost[]
  forumReplies            ForumReply[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([tier])
}

model DealerContact {
  id        String  @id @default(cuid())
  dealerId  String
  dealer    Dealer  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  type      String  // primary, billing, shipping, support
  name      String
  email     String
  phone     String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealerId])
}

model DealerAddress {
  id        String  @id @default(cuid())
  dealerId  String
  dealer    Dealer  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  type      String  // billing, shipping, physical
  street    String
  street2   String?
  city      String
  state     String
  zipCode   String
  country   String  @default("US")
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealerId])
}

// ============================================================================
// PRODUCTS & INVENTORY
// ============================================================================

model ProductCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
}

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?

  categoryId  String?
  category    ProductCategory? @relation(fields: [categoryId], references: [id])

  price       Float    // Base price
  costPrice   Float?   // Cost for margin calculation
  status      String   @default("active") // active, discontinued, draft

  // Specifications stored as JSON string (SQLite doesn't have native JSON)
  specifications String? // JSON string

  images          ProductImage[]
  inventory       Inventory[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  demandForecasts DemandForecast[]
  suggestedOrders SuggestedOrder[]
  warrantyClaims  WarrantyClaim[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sku])
  @@index([categoryId])
  @@index([status])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  altText   String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([productId])
}

model InventoryLocation {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  type      String   // warehouse, store, distribution_center
  address   String?
  isActive  Boolean  @default(true)

  inventory Inventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  locationId  String
  location    InventoryLocation @relation(fields: [locationId], references: [id])

  quantity    Int      @default(0)
  reserved    Int      @default(0) // Reserved for pending orders
  lowStockThreshold Int @default(10)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

// ============================================================================
// SHOPPING CART
// ============================================================================

model Cart {
  id        String   @id @default(cuid())
  dealerId  String
  dealer    Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  userId    String?  // Optional - which user created the cart
  name      String?  // For saved carts
  isSaved   Boolean  @default(false) // true for saved carts, false for active cart

  items     CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealerId])
  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

// ============================================================================
// ORDERS
// ============================================================================

model Order {
  id            String   @id @default(cuid())
  orderNumber   String   @unique
  dealerId      String
  dealer        Dealer   @relation(fields: [dealerId], references: [id])

  status        String   @default("draft") // draft, submitted, confirmed, processing, shipped, delivered, cancelled

  // Pricing
  subtotal      Float    @default(0)
  taxAmount     Float    @default(0)
  shippingAmount Float   @default(0)
  totalAmount   Float    @default(0)

  // Addresses (stored as JSON strings for flexibility)
  shippingAddress String? // JSON string
  billingAddress  String? // JSON string

  // Tracking
  poNumber      String?  // Customer's PO number
  notes         String?

  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  invoices      Invoice[]
  orderNotes    OrderNote[]

  submittedAt   DateTime?
  confirmedAt   DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  cancelledAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderNumber])
  @@index([dealerId])
  @@index([status])
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id])

  quantity    Int
  unitPrice   Float
  totalPrice  Float

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
}

model OrderStatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    String
  note      String?
  changedBy String?  // User ID who made the change

  createdAt DateTime @default(now())

  @@index([orderId])
}

model OrderNote {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  content    String
  isInternal Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id              String    @id @default(cuid())
  invoiceNumber   String    @unique
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  status          String    @default("draft") // draft, sent, paid, overdue, cancelled

  // Amounts
  subtotal        Float     @default(0)
  taxAmount       Float     @default(0)
  shippingAmount  Float     @default(0)
  totalAmount     Float     @default(0)

  // Dates
  dueDate         DateTime?
  paidDate        DateTime?

  // Details (stored as JSON)
  items           String?   // JSON array of line items
  billingAddress  String?   // JSON object
  shippingAddress String?   // JSON object
  paymentTerms    String    @default("Net 30")
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([invoiceNumber])
  @@index([orderId])
  @@index([dealerId])
  @@index([status])
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model Document {
  id          String   @id @default(cuid())
  dealerId    String?
  dealer      Dealer?  @relation(fields: [dealerId], references: [id])

  name        String
  category    String   // contract, marketing, compliance, training, product_spec
  mimeType    String
  size        Int      // File size in bytes
  url         String   // S3 URL or local path

  version     Int      @default(1)
  isPublic    Boolean  @default(false)

  // Access control
  accessLevel String   @default("dealer") // public, dealer, role, user
  allowedRoles String? // JSON array of allowed roles
  allowedUsers String? // JSON array of allowed user IDs

  expiresAt   DateTime?
  uploadedBy  String?

  // Version control
  parentDocumentId String?
  parentDocument   Document?  @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  versions         Document[] @relation("DocumentVersions")

  // Tracking
  accessLogs       DocumentAccessLog[]
  expiryReminders  DocumentExpiryReminder[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([dealerId])
  @@index([category])
  @@index([parentDocumentId])
  @@index([expiresAt])
}

model DocumentAccessLog {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId      String
  action      String   // view, download, share, edit
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([documentId])
  @@index([userId])
  @@index([createdAt])
}

model DocumentExpiryReminder {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId      String
  reminderDays Int     @default(30) // Days before expiry to send reminder
  sentAt      DateTime?
  acknowledged Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([documentId, userId, reminderDays])
  @@index([documentId])
  @@index([userId])
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String    // order_update, low_stock, document_expiry, system, announcement
  title     String
  body      String
  data      String?   // JSON string for additional data
  priority  String    @default("normal") // low, normal, high, urgent

  // Email delivery tracking
  emailSent Boolean   @default(false)
  emailSentAt DateTime?

  readAt    DateTime?

  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model NotificationPreference {
  id        String    @id @default(cuid())
  userId    String    @unique

  // In-app notification preferences
  orderUpdates          Boolean @default(true)
  lowStockAlerts        Boolean @default(true)
  invoiceNotifications  Boolean @default(true)
  documentExpiry        Boolean @default(true)
  systemAnnouncements   Boolean @default(true)
  warrantyUpdates       Boolean @default(true)

  // Email notification preferences
  emailOrderUpdates     Boolean @default(true)
  emailInvoices         Boolean @default(true)
  emailDocumentExpiry   Boolean @default(true)
  emailSystemAnnouncements Boolean @default(false)
  emailDigestFrequency  String  @default("instant") // instant, daily, weekly, never

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
}

model SystemAnnouncement {
  id          String    @id @default(cuid())
  title       String
  body        String
  type        String    @default("info") // info, warning, alert, maintenance
  priority    String    @default("normal") // low, normal, high, critical

  // Targeting
  targetAll   Boolean   @default(true)
  targetRoles String?   // JSON array of roles to target
  targetTiers String?   // JSON array of dealer tiers to target

  // Display settings
  isDismissible Boolean @default(true)
  showAsBanner  Boolean @default(false) // Show as a top banner vs notification

  // Scheduling
  publishAt   DateTime  @default(now())
  expiresAt   DateTime?

  // Status
  isActive    Boolean   @default(true)
  createdBy   String?

  // Tracking
  readReceipts AnnouncementReadReceipt[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@index([publishAt])
  @@index([expiresAt])
}

model AnnouncementReadReceipt {
  id              String   @id @default(cuid())
  announcementId  String
  announcement    SystemAnnouncement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId          String
  dismissed       Boolean  @default(false)

  readAt          DateTime @default(now())

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  action      String   // create, update, delete, login, logout
  entityType  String   // User, Dealer, Order, Product, etc.
  entityId    String?

  // Changes stored as JSON string
  oldValues   String?  // JSON string
  newValues   String?  // JSON string

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================================================
// INVENTORY FORECASTING
// ============================================================================

model ForecastConfig {
  id                  String   @id @default(cuid())
  dealerId            String
  dealer              Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  // Forecasting parameters
  forecastHorizon     Int      @default(18) // Months to forecast ahead
  historyPeriod       Int      @default(24) // Months of history to analyze
  confidenceLevel     Float    @default(0.95) // 95% confidence interval

  // Seasonal adjustments
  useSeasonality      Boolean  @default(true)
  seasonalityType     String   @default("multiplicative") // additive, multiplicative

  // Safety stock settings
  safetyStockDays     Int      @default(14) // Days of safety stock
  leadTimeDays        Int      @default(7)  // Average lead time for orders

  // Reorder settings
  reorderPointMethod  String   @default("dynamic") // fixed, dynamic, min_max
  minOrderQuantity    Int      @default(1)
  orderMultiple       Int      @default(1) // Order in multiples of this

  // Market factors
  marketGrowthRate    Float    @default(0) // Annual market growth %
  localMarketFactor   Float    @default(1.0) // Local market adjustment

  isActive            Boolean  @default(true)
  lastCalculatedAt    DateTime?

  demandForecasts     DemandForecast[]
  suggestedOrders     SuggestedOrder[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([dealerId])
  @@index([dealerId])
}

model DemandForecast {
  id              String   @id @default(cuid())
  forecastConfigId String
  forecastConfig  ForecastConfig @relation(fields: [forecastConfigId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Period information
  periodStart     DateTime // Start of forecast period
  periodEnd       DateTime // End of forecast period
  periodType      String   @default("month") // week, month, quarter

  // Forecast values
  forecastedDemand    Float   // Expected demand quantity
  lowerBound          Float   // Lower confidence bound
  upperBound          Float   // Upper confidence bound

  // Historical comparison
  historicalAverage   Float?  // Average from same period in history
  yearOverYearChange  Float?  // % change vs same period last year

  // Trend and seasonality components
  trendComponent      Float?  // Trend contribution
  seasonalComponent   Float?  // Seasonal contribution

  // Accuracy (filled in after actuals are known)
  actualDemand        Float?  // Actual demand (updated later)
  forecastError       Float?  // % error = (actual - forecast) / actual

  // Metadata
  modelVersion        String  @default("v1.0")
  calculatedAt        DateTime @default(now())

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([forecastConfigId, productId, periodStart])
  @@index([forecastConfigId])
  @@index([productId])
  @@index([periodStart])
}

model SuggestedOrder {
  id              String   @id @default(cuid())
  forecastConfigId String
  forecastConfig  ForecastConfig @relation(fields: [forecastConfigId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Order timing
  suggestedOrderDate  DateTime // When to place the order
  expectedDeliveryDate DateTime // When inventory will arrive

  // Order quantities
  suggestedQuantity   Int     // Recommended order quantity
  minimumQuantity     Int     // Minimum to maintain service level
  economicOrderQty    Int?    // EOQ if calculated

  // Inventory projections
  currentStock        Int     // Stock at time of calculation
  projectedStock      Int     // Stock at order date (before order)
  projectedDemand     Int     // Expected demand until next order

  // Financial
  estimatedCost       Float?  // Estimated order cost
  estimatedValue      Float?  // Retail value of order

  // Urgency and status
  priority            String  @default("normal") // critical, high, normal, low
  status              String  @default("pending") // pending, accepted, ordered, skipped

  // Reasoning
  reasoning           String? // JSON: why this recommendation was made

  // Tracking
  acceptedAt          DateTime?
  orderedAt           DateTime?
  actualOrderId       String?  // Link to actual order if placed

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([forecastConfigId])
  @@index([productId])
  @@index([suggestedOrderDate])
  @@index([status])
}

model SeasonalPattern {
  id          String   @id @default(cuid())
  dealerId    String?  // null = global pattern
  productId   String?  // null = category-wide pattern
  categoryId  String?  // null = all categories

  // Pattern definition
  patternName String   // e.g., "Holiday Season", "Summer Peak"
  patternType String   @default("monthly") // weekly, monthly, quarterly

  // Seasonal factors (JSON array of 12 monthly factors or 52 weekly factors)
  // e.g., [0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.3, 1.1, 1.0, 0.9, 1.5] for monthly
  factors     String   // JSON array of seasonal multipliers

  // Validity
  validFrom   DateTime?
  validTo     DateTime?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([dealerId])
  @@index([productId])
  @@index([categoryId])
}

model MarketIndicator {
  id              String   @id @default(cuid())

  // Geographic scope
  region          String   // e.g., "Northeast", "CA", "90210"
  regionType      String   // state, zipcode, region, national

  // Indicator details
  indicatorName   String   // e.g., "Housing Starts", "Consumer Confidence"
  indicatorType   String   // economic, demographic, industry, weather

  // Time series data
  periodStart     DateTime
  periodEnd       DateTime
  value           Float
  previousValue   Float?
  percentChange   Float?

  // Impact assessment
  impactFactor    Float    @default(1.0) // Multiplier effect on demand
  confidence      Float    @default(0.8) // Confidence in the indicator

  // Source
  source          String?  // Data source
  sourceUrl       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([region, indicatorName, periodStart])
  @@index([region])
  @@index([indicatorType])
  @@index([periodStart])
}

// ============================================================================
// WARRANTY CLAIMS
// ============================================================================

model WarrantyClaim {
  id              String    @id @default(cuid())
  claimNumber     String    @unique // WC-2025-00001 format
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  submittedById   String
  submittedBy     User      @relation("WarrantySubmitter", fields: [submittedById], references: [id])
  assignedToId    String?
  assignedTo      User?     @relation("WarrantyAssignee", fields: [assignedToId], references: [id])

  // Status workflow: draft -> submitted -> under_review -> info_requested -> approved/denied/partial
  status          String    @default("draft")

  // Claim type
  claimType       String    // product_defect, shipping_damage, missing_parts, other

  // Product information
  productId       String?
  product         Product?  @relation(fields: [productId], references: [id])
  productName     String    // Store name even if product deleted
  serialNumber    String?
  modelNumber     String?
  purchaseDate    DateTime?
  installDate     DateTime?

  // Customer information (end user who experienced the issue)
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerAddress String?   // JSON string

  // Issue details
  issueDescription    String
  failureDate         DateTime?
  isUnderWarranty     Boolean   @default(true)

  // Resolution
  resolutionType      String?   // replacement, repair, credit, denial
  resolutionNotes     String?

  // Amounts
  laborHours          Float?
  laborRate           Float?
  partsAmount         Float     @default(0)
  laborAmount         Float     @default(0)
  shippingAmount      Float     @default(0)
  totalRequested      Float     @default(0)
  totalApproved       Float?

  // Tracking
  priority            String    @default("normal") // low, normal, high, urgent

  items               WarrantyClaimItem[]
  attachments         WarrantyClaimAttachment[]
  notes               WarrantyClaimNote[]
  statusHistory       WarrantyClaimStatusHistory[]

  submittedAt         DateTime?
  reviewedAt          DateTime?
  resolvedAt          DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([claimNumber])
  @@index([dealerId])
  @@index([status])
  @@index([submittedById])
  @@index([assignedToId])
  @@index([createdAt])
}

model WarrantyClaimItem {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  partNumber      String?
  partName        String
  quantity        Int       @default(1)
  unitCost        Float     @default(0)
  totalCost       Float     @default(0)

  issueType       String    // defective, damaged, missing, worn, other
  issueDescription String?

  // Resolution for this specific item
  approved        Boolean?
  approvedQty     Int?
  approvedAmount  Float?
  denialReason    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([claimId])
}

model WarrantyClaimAttachment {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  filename        String
  originalName    String
  mimeType        String
  size            Int       // bytes
  url             String    // Storage URL

  category        String    @default("photo") // photo, receipt, invoice, document, other
  description     String?

  uploadedById    String?

  createdAt       DateTime  @default(now())

  @@index([claimId])
}

model WarrantyClaimNote {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  content         String
  isInternal      Boolean   @default(false) // Internal notes only visible to manufacturer
  isSystemNote    Boolean   @default(false) // Auto-generated status change notes

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([claimId])
  @@index([userId])
}

model WarrantyClaimStatusHistory {
  id              String    @id @default(cuid())
  claimId         String
  claim           WarrantyClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  fromStatus      String?
  toStatus        String
  changedById     String?
  note            String?

  createdAt       DateTime  @default(now())

  @@index([claimId])
  @@index([createdAt])
}

// ============================================================================
// PHASE 8: RELATIONSHIP LAYER
// ============================================================================

// ============================================================================
// 8.1 COMMUNICATION HUB
// ============================================================================

model SupportTicket {
  id              String    @id @default(cuid())
  ticketNumber    String    @unique // TKT-2025-00001 format
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  submittedById   String
  submittedBy     User      @relation("TicketSubmitter", fields: [submittedById], references: [id])
  assignedToId    String?
  assignedTo      User?     @relation("TicketAssignee", fields: [assignedToId], references: [id])

  // Ticket details
  category        String    // product, warranty, order, billing, technical, other
  subcategory     String?
  subject         String
  description     String
  priority        String    @default("normal") // low, normal, high, urgent

  // Status workflow: open -> in_progress -> pending_dealer -> resolved -> closed
  status          String    @default("open")

  // SLA tracking
  slaResponseDue  DateTime?
  slaResolutionDue DateTime?
  firstResponseAt DateTime?
  escalatedAt     DateTime?
  escalationLevel Int       @default(0)

  // Resolution
  resolutionNotes String?
  satisfactionRating Int?   // 1-5 rating from dealer

  messages        TicketMessage[]
  attachments     TicketAttachment[]

  resolvedAt      DateTime?
  closedAt        DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ticketNumber])
  @@index([dealerId])
  @@index([status])
  @@index([assignedToId])
  @@index([priority])
  @@index([createdAt])
}

model TicketMessage {
  id              String    @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  content         String
  isInternal      Boolean   @default(false) // Internal notes visible only to OEM reps
  isSystemMessage Boolean   @default(false) // Auto-generated status messages

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model TicketAttachment {
  id              String    @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  filename        String
  originalName    String
  mimeType        String
  size            Int       // bytes
  url             String    // Storage URL

  uploadedById    String?

  createdAt       DateTime  @default(now())

  @@index([ticketId])
}

model KnowledgeCategory {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  parentId        String?
  parent          KnowledgeCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        KnowledgeCategory[] @relation("CategoryHierarchy")
  sortOrder       Int       @default(0)
  isActive        Boolean   @default(true)

  articles        KnowledgeArticle[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
}

model KnowledgeArticle {
  id              String    @id @default(cuid())
  categoryId      String
  category        KnowledgeCategory @relation(fields: [categoryId], references: [id])

  title           String
  slug            String    @unique
  content         String    // Markdown content
  excerpt         String?   // Short summary for listings

  // Visibility
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  targetRoles     String?   // JSON array of roles who can view
  targetTiers     String?   // JSON array of dealer tiers who can view

  // Metadata
  tags            String?   // JSON array of tags
  authorId        String?
  viewCount       Int       @default(0)
  helpfulCount    Int       @default(0)
  notHelpfulCount Int       @default(0)

  // Related tickets (used to answer)
  relatedTickets  String?   // JSON array of ticket IDs

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([categoryId])
  @@index([slug])
  @@index([isPublished])
}

// ============================================================================
// 8.2 INCENTIVES & PROGRAMS
// ============================================================================

model IncentiveProgram {
  id              String    @id @default(cuid())
  name            String
  code            String    @unique // REBATE-2025-Q1, COOP-2025
  description     String?

  // Program type
  type            String    // rebate, coop, contest, spiff
  subtype         String?   // volume_based, tiered, flat_rate, etc.

  // Dates
  startDate       DateTime
  endDate         DateTime?
  enrollmentDeadline DateTime?

  // Status
  status          String    @default("draft") // draft, active, paused, completed, cancelled

  // Eligibility
  eligibleTiers   String?   // JSON array of dealer tiers
  eligibleRegions String?   // JSON array of regions
  minOrderVolume  Float?    // Minimum order volume to qualify

  // Rules (JSON structure for flexibility)
  rules           String    // JSON: tier thresholds, rates, caps, etc.

  // Funding
  budgetAmount    Float?    // Total program budget
  spentAmount     Float     @default(0) // Tracked spend

  // Settings
  autoEnroll      Boolean   @default(false)
  requiresApproval Boolean  @default(true)

  createdBy       String?

  enrollments     DealerProgramEnrollment[]
  accruals        RebateAccrual[]
  claims          IncentiveClaim[]
  payouts         IncentivePayout[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([code])
  @@index([status])
  @@index([type])
  @@index([startDate])
}

model DealerProgramEnrollment {
  id              String    @id @default(cuid())
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  programId       String
  program         IncentiveProgram @relation(fields: [programId], references: [id])

  status          String    @default("pending") // pending, active, suspended, withdrawn
  enrolledAt      DateTime  @default(now())
  approvedAt      DateTime?
  approvedById    String?

  // Tracking
  accruedAmount   Float     @default(0)
  paidAmount      Float     @default(0)
  pendingAmount   Float     @default(0)

  // Terms acceptance
  termsAcceptedAt DateTime?
  termsVersion    String?

  // Custom settings per dealer
  customRules     String?   // JSON for dealer-specific adjustments

  withdrawnAt     DateTime?
  withdrawReason  String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([dealerId, programId])
  @@index([dealerId])
  @@index([programId])
  @@index([status])
}

model RebateAccrual {
  id              String    @id @default(cuid())
  programId       String
  program         IncentiveProgram @relation(fields: [programId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Period
  periodType      String    // monthly, quarterly, annual
  periodStart     DateTime
  periodEnd       DateTime

  // Amounts
  qualifyingVolume Float    // Sales volume that qualified
  rebateRate      Float     // Rate applied (e.g., 0.03 for 3%)
  accruedAmount   Float     // Calculated rebate amount
  adjustments     Float     @default(0) // Manual adjustments
  finalAmount     Float     // accruedAmount + adjustments

  // Tier achieved
  tierAchieved    String?   // Which tier they reached
  tierProgress    Float?    // Progress toward next tier (0-100%)

  // Status
  status          String    @default("calculated") // calculated, approved, paid
  approvedById    String?
  approvedAt      DateTime?

  // Reference
  orderId         String?   // Link to specific order if applicable
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([programId, dealerId, periodStart])
  @@index([programId])
  @@index([dealerId])
  @@index([periodStart])
  @@index([status])
}

model IncentiveClaim {
  id              String    @id @default(cuid())
  claimNumber     String    @unique // CLM-2025-00001
  programId       String
  program         IncentiveProgram @relation(fields: [programId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  submittedById   String
  submittedBy     User      @relation(fields: [submittedById], references: [id])

  // Claim type
  claimType       String    // rebate_payout, coop_reimbursement, spiff_claim

  // Amounts
  requestedAmount Float
  approvedAmount  Float?
  paidAmount      Float?

  // Details
  description     String?
  supportingInfo  String?   // JSON: invoice numbers, dates, etc.

  // Status workflow: draft -> submitted -> under_review -> approved/denied -> paid
  status          String    @default("draft")
  reviewedById    String?
  reviewNotes     String?
  denialReason    String?

  documents       IncentiveClaimDocument[]

  submittedAt     DateTime?
  reviewedAt      DateTime?
  approvedAt      DateTime?
  paidAt          DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([claimNumber])
  @@index([programId])
  @@index([dealerId])
  @@index([status])
}

model IncentiveClaimDocument {
  id              String    @id @default(cuid())
  claimId         String
  claim           IncentiveClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  filename        String
  originalName    String
  mimeType        String
  size            Int
  url             String

  documentType    String    // invoice, receipt, proof_of_purchase, ad_copy, other
  description     String?

  uploadedById    String?

  createdAt       DateTime  @default(now())

  @@index([claimId])
}

model IncentivePayout {
  id              String    @id @default(cuid())
  programId       String
  program         IncentiveProgram @relation(fields: [programId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Payout details
  payoutType      String    // rebate, coop, spiff, adjustment
  amount          Float
  paymentMethod   String?   // check, ach, credit, offset

  // Reference
  referenceNumber String?   // Check number, ACH confirmation, etc.
  periodCovered   String?   // e.g., "Q1 2025"

  // Status
  status          String    @default("pending") // pending, processing, completed, failed
  scheduledDate   DateTime?
  paidDate        DateTime?
  failedReason    String?

  notes           String?
  processedById   String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([programId])
  @@index([dealerId])
  @@index([status])
  @@index([scheduledDate])
}

// ============================================================================
// 8.3 TRAINING & CERTIFICATION PORTAL
// ============================================================================

model TrainingCourse {
  id              String    @id @default(cuid())
  code            String    @unique // TRN-PROD-001
  title           String
  description     String?
  shortDescription String?  // For card listings

  // Categorization
  category        String    // product, sales, service, compliance, safety
  subcategory     String?
  tags            String?   // JSON array of tags

  // Requirements
  isRequired      Boolean   @default(false)
  requiredForRoles String?  // JSON array of roles
  requiredForTiers String?  // JSON array of dealer tiers
  prerequisiteCourseIds String? // JSON array of course IDs

  // Course details
  durationMinutes Int       @default(0)
  passingScore    Int       @default(70) // Percentage to pass quiz
  maxAttempts     Int       @default(3)  // Max quiz attempts

  // Certification
  certificationValid Int?   // Months certification is valid (null = no expiration)
  certificateTemplateUrl String?

  // Media
  thumbnailUrl    String?
  previewVideoUrl String?

  // Status
  status          String    @default("draft") // draft, published, archived
  publishedAt     DateTime?
  archivedAt      DateTime?

  // Version control
  version         String    @default("1.0")

  createdBy       String?

  contents        CourseContent[]
  quizzes         Quiz[]
  assignments     TrainingAssignment[]
  progress        CourseProgress[]
  certifications  Certification[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([code])
  @@index([category])
  @@index([status])
  @@index([isRequired])
}

model CourseContent {
  id              String    @id @default(cuid())
  courseId        String
  course          TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Content details
  title           String
  contentType     String    // video, document, slide, scorm, external_link
  contentUrl      String?   // URL to content
  contentBody     String?   // For text/HTML content

  // Order and structure
  moduleNumber    Int       @default(1)  // Which module
  lessonNumber    Int       @default(1)  // Lesson within module
  sortOrder       Int       @default(0)

  // Timing
  durationMinutes Int       @default(0)

  // Completion requirements
  isRequired      Boolean   @default(true)
  minWatchTime    Int?      // Minimum seconds to watch (for video)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([courseId])
  @@index([sortOrder])
}

model Quiz {
  id              String    @id @default(cuid())
  courseId        String
  course          TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title           String
  description     String?
  quizType        String    @default("final") // module, final, pre_assessment

  // Quiz settings
  timeLimitMinutes Int?     // null = no limit
  passingScore    Int       @default(70)
  randomizeQuestions Boolean @default(true)
  randomizeAnswers Boolean @default(true)
  showCorrectAnswers Boolean @default(true) // After completion
  questionsToShow Int?      // If null, show all questions

  sortOrder       Int       @default(0)

  questions       QuizQuestion[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([courseId])
}

model QuizQuestion {
  id              String    @id @default(cuid())
  quizId          String
  quiz            Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionType    String    // multiple_choice, true_false, multi_select
  question        String
  explanation     String?   // Explanation shown after answer

  // Answers stored as JSON: [{ text, isCorrect, sortOrder }]
  answers         String    // JSON array

  // Weighting
  points          Int       @default(1)
  sortOrder       Int       @default(0)

  // Media
  imageUrl        String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([quizId])
}

model TrainingAssignment {
  id              String    @id @default(cuid())
  courseId        String
  course          TrainingCourse @relation(fields: [courseId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Assignment details
  assignedById    String?
  dueDate         DateTime?
  priority        String    @default("normal") // low, normal, high, urgent

  // Status
  status          String    @default("assigned") // assigned, in_progress, completed, overdue

  // Notifications
  reminderSentAt  DateTime?
  overdueSentAt   DateTime?

  completedAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([courseId, userId])
  @@index([userId])
  @@index([dealerId])
  @@index([status])
  @@index([dueDate])
}

model CourseProgress {
  id              String    @id @default(cuid())
  courseId        String
  course          TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  // Progress tracking
  status          String    @default("not_started") // not_started, in_progress, completed
  percentComplete Int       @default(0)

  // Content progress (JSON: { contentId: { viewed, viewedAt, timeSpent } })
  contentProgress String?   // JSON object

  // Quiz results (JSON: { quizId: { attempts, bestScore, passedAt } })
  quizResults     String?   // JSON object

  // Time tracking
  totalTimeMinutes Int      @default(0)
  lastAccessedAt  DateTime?

  startedAt       DateTime?
  completedAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([courseId, userId])
  @@index([userId])
  @@index([status])
}

model Certification {
  id              String    @id @default(cuid())
  courseId        String
  course          TrainingCourse @relation(fields: [courseId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Certification details
  certificateNumber String  @unique // CERT-2025-00001
  status          String    @default("active") // active, expired, revoked

  // Scores
  finalScore      Int       // Quiz score achieved
  attemptNumber   Int       @default(1)

  // Validity
  issuedAt        DateTime  @default(now())
  expiresAt       DateTime?
  revokedAt       DateTime?
  revokeReason    String?

  // Certificate file
  certificateUrl  String?

  // Renewal tracking
  renewalReminderSentAt DateTime?
  renewedFromId   String?   // Previous certification if renewal

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([courseId])
  @@index([userId])
  @@index([dealerId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================================
// 8.4 DEALER PERFORMANCE SCORECARD
// ============================================================================

model DealerScorecard {
  id              String    @id @default(cuid())
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Period
  periodType      String    @default("monthly") // monthly, quarterly, annual
  periodStart     DateTime
  periodEnd       DateTime

  // Sales Metrics
  salesActual     Float     @default(0)
  salesTarget     Float     @default(0)
  salesScore      Float     @default(0) // Normalized 0-100
  salesYoYChange  Float?    // % change vs same period last year

  // Growth
  revenueGrowth   Float?    // % revenue growth
  unitGrowth      Float?    // % unit sales growth
  growthScore     Float     @default(0)

  // Customer Satisfaction
  csiScore        Float?    // Customer satisfaction index
  csiSampleSize   Int?
  csiScore100     Float     @default(0) // Normalized 0-100

  // Warranty/Quality
  warrantyClaimRate Float?  // Claims per 100 units
  warrantyClaimCount Int    @default(0)
  warrantyScore   Float     @default(0)

  // Training Compliance
  trainingComplianceRate Float @default(0) // % of required training completed
  certifiedStaffCount Int   @default(0)
  totalStaffCount Int       @default(0)
  trainingScore   Float     @default(0)

  // Inventory Management
  inventoryTurnRate Float?  // Turns per year
  daysOfSupply    Float?
  stockoutRate    Float?    // % of time key items out of stock
  inventoryScore  Float     @default(0)

  // Payment Performance
  avgDaysToPay    Float?
  onTimePaymentRate Float?  // % of invoices paid on time
  paymentScore    Float     @default(0)

  // Composite Score
  compositeScore  Float     @default(0) // Weighted average (0-100)
  scoreRank       Int?      // Rank among all dealers
  tierRecommendation String? // Recommended tier based on score

  // Trend
  previousCompositeScore Float?
  scoreTrend      String?   // up, down, stable

  // Metadata
  calculatedAt    DateTime  @default(now())
  calculatedBy    String?   // System or manual

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([dealerId, periodStart, periodType])
  @@index([dealerId])
  @@index([periodStart])
  @@index([compositeScore])
}

model PerformanceMetric {
  id              String    @id @default(cuid())
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  metricType      String    // sales, csi, warranty, training, inventory, payment
  metricName      String    // Specific metric name

  // Time period
  periodStart     DateTime
  periodEnd       DateTime

  // Values
  value           Float
  previousValue   Float?
  target          Float?
  benchmark       Float?    // Network/industry average

  // Analysis
  percentChange   Float?
  percentOfTarget Float?
  percentile      Float?    // Percentile rank in network

  // Metadata
  source          String?   // Where the data came from
  notes           String?

  createdAt       DateTime  @default(now())

  @@index([dealerId])
  @@index([metricType])
  @@index([periodStart])
}

model SalesTarget {
  id              String    @id @default(cuid())
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Target period
  year            Int
  quarter         Int?      // null = annual target
  month           Int?      // null = quarterly/annual

  // Target values
  revenueTarget   Float     @default(0)
  unitTarget      Int       @default(0)
  marginTarget    Float?    // Target margin %

  // By category (JSON for flexibility)
  categoryTargets String?   // JSON: { categoryId: { revenue, units } }

  // Status
  status          String    @default("active") // draft, active, locked
  approvedById    String?
  approvedAt      DateTime?

  // Actuals (updated as sales come in)
  revenueActual   Float     @default(0)
  unitActual      Int       @default(0)

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([dealerId, year, quarter, month])
  @@index([dealerId])
  @@index([year])
}

model ScoreWeight {
  id              String    @id @default(cuid())

  // Scope (null = global default)
  dealerTier      String?   // Apply different weights by tier
  effectiveDate   DateTime  @default(now())

  // Weights (must sum to 100)
  salesWeight     Float     @default(30)
  growthWeight    Float     @default(15)
  csiWeight       Float     @default(20)
  warrantyWeight  Float     @default(10)
  trainingWeight  Float     @default(10)
  inventoryWeight Float     @default(10)
  paymentWeight   Float     @default(5)

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([dealerTier])
  @@index([isActive])
}

model TierThreshold {
  id              String    @id @default(cuid())

  tierName        String    // platinum, gold, silver, bronze
  minScore        Float     // Minimum composite score for tier
  maxScore        Float?    // Maximum (null for top tier)

  // Additional criteria
  minAnnualRevenue Float?
  minYearsActive  Int?

  // Benefits (JSON for flexibility)
  benefits        String?   // JSON: { rebateRate, coopRate, supportLevel, etc. }

  sortOrder       Int       @default(0) // For display order
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tierName])
  @@index([isActive])
}

// ============================================================================
// 8.5 PARTS & SERVICE MODULE
// ============================================================================

model Part {
  id              String    @id @default(cuid())
  partNumber      String    @unique
  name            String
  description     String?

  categoryId      String?
  category        PartCategory? @relation(fields: [categoryId], references: [id])

  // Pricing
  listPrice       Float     @default(0)
  dealerPrice     Float     @default(0)
  costPrice       Float?

  // Inventory
  quantityOnHand  Int       @default(0)
  quantityReserved Int      @default(0)
  reorderPoint    Int       @default(5)
  reorderQuantity Int       @default(10)

  // Attributes
  weight          Float?    // For shipping calculation
  dimensions      String?   // JSON: { length, width, height }
  unitOfMeasure   String    @default("each") // each, set, pair, etc.

  // Status
  status          String    @default("active") // active, discontinued, backordered

  // Media
  imageUrl        String?
  specSheetUrl    String?

  // Cross-reference
  supersededByPartId String?
  supersededBy    Part?     @relation("PartSupersedes", fields: [supersededByPartId], references: [id])
  supersedes      Part[]    @relation("PartSupersedes")

  // Applicable products (JSON array of product IDs)
  applicableProducts String? // JSON array

  partsOrderItems PartsOrderItem[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([partNumber])
  @@index([categoryId])
  @@index([status])
}

model PartCategory {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  parentId        String?
  parent          PartCategory?  @relation("PartCategoryHierarchy", fields: [parentId], references: [id])
  children        PartCategory[] @relation("PartCategoryHierarchy")
  sortOrder       Int       @default(0)

  parts           Part[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
}

model PartsOrder {
  id              String    @id @default(cuid())
  orderNumber     String    @unique // PO-2025-00001
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  orderedById     String
  orderedBy       User      @relation(fields: [orderedById], references: [id])

  // Status
  status          String    @default("draft") // draft, submitted, confirmed, shipped, delivered, cancelled

  // Amounts
  subtotal        Float     @default(0)
  shippingAmount  Float     @default(0)
  taxAmount       Float     @default(0)
  totalAmount     Float     @default(0)

  // Shipping
  shippingAddress String?   // JSON
  shippingMethod  String?
  trackingNumber  String?

  // Reference
  poNumber        String?   // Dealer's PO
  notes           String?
  isRush          Boolean   @default(false)

  items           PartsOrderItem[]

  submittedAt     DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orderNumber])
  @@index([dealerId])
  @@index([status])
}

model PartsOrderItem {
  id              String    @id @default(cuid())
  orderId         String
  order           PartsOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partId          String
  part            Part      @relation(fields: [partId], references: [id])

  quantity        Int
  unitPrice       Float
  totalPrice      Float

  // For tracking partial shipments
  quantityShipped Int       @default(0)
  quantityBackordered Int   @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orderId])
  @@index([partId])
}

model ServiceBulletin {
  id              String    @id @default(cuid())
  bulletinNumber  String    @unique // TSB-2025-001
  title           String
  description     String
  content         String    // Full bulletin content (markdown)

  // Categorization
  category        String    // safety, recall, service, technical, product_update
  severity        String    @default("normal") // critical, high, normal, low

  // Affected items
  affectedProducts String?  // JSON array of product IDs
  affectedSerialRange String? // e.g., "SN001000-SN005000"
  affectedModelYears String? // e.g., "2023-2025"

  // Action required
  actionRequired  String?   // What dealers need to do
  laborTimeHours  Float?    // Estimated labor time
  partsRequired   String?   // JSON array of part numbers

  // Dates
  effectiveDate   DateTime
  expirationDate  DateTime?

  // Status
  status          String    @default("draft") // draft, published, superseded, expired

  // Attachments
  attachmentUrls  String?   // JSON array of URLs

  // Tracking
  publishedById   String?
  publishedAt     DateTime?
  viewCount       Int       @default(0)

  acknowledgments ServiceBulletinAcknowledgment[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bulletinNumber])
  @@index([category])
  @@index([severity])
  @@index([status])
}

model ServiceBulletinAcknowledgment {
  id              String    @id @default(cuid())
  bulletinId      String
  bulletin        ServiceBulletin @relation(fields: [bulletinId], references: [id], onDelete: Cascade)
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  acknowledgedAt  DateTime  @default(now())

  @@unique([bulletinId, dealerId])
  @@index([bulletinId])
  @@index([dealerId])
}

model RecallNotice {
  id              String    @id @default(cuid())
  recallNumber    String    @unique // RCL-2025-001
  title           String
  description     String
  content         String    // Full recall details

  // Regulatory
  nhtsaCampaignNumber String? // NHTSA campaign number if applicable
  regulatoryBody  String?   // NHTSA, Transport Canada, etc.

  // Severity
  severity        String    // critical, high, normal
  safetyRisk      String?   // Description of safety risk

  // Affected items
  affectedProducts String?  // JSON array of product IDs
  affectedSerialRange String?
  affectedModelYears String?
  estimatedAffectedUnits Int?

  // Remedy
  remedyDescription String?
  remedyAvailableDate DateTime?
  partsAvailable  Boolean   @default(false)

  // Dates
  announcedDate   DateTime
  remedyDeadline  DateTime?

  // Status
  status          String    @default("active") // active, completed, superseded

  // Dealer tracking
  dealerNotifications RecallDealerNotification[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([recallNumber])
  @@index([severity])
  @@index([status])
}

model RecallDealerNotification {
  id              String    @id @default(cuid())
  recallId        String
  recall          RecallNotice @relation(fields: [recallId], references: [id], onDelete: Cascade)
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  // Affected inventory at this dealer
  affectedUnits   Int       @default(0)
  unitsRemedied   Int       @default(0)

  // Status
  status          String    @default("notified") // notified, acknowledged, in_progress, completed

  acknowledgedAt  DateTime?
  completedAt     DateTime?

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([recallId, dealerId])
  @@index([recallId])
  @@index([dealerId])
  @@index([status])
}

// ============================================================================
// 8.6 MARKETING ASSET LIBRARY
// ============================================================================

model MarketingAsset {
  id              String    @id @default(cuid())
  name            String
  description     String?

  categoryId      String
  category        MarketingAssetCategory @relation(fields: [categoryId], references: [id])

  // File details
  assetType       String    // image, video, document, template, branding
  mimeType        String
  fileSize        Int       // bytes
  url             String
  thumbnailUrl    String?

  // Dimensions (for images/videos)
  width           Int?
  height          Int?
  duration        Int?      // seconds for video

  // Metadata
  tags            String?   // JSON array
  brand           String?   // Product brand
  campaign        String?   // Campaign name
  year            Int?

  // Availability
  status          String    @default("active") // draft, active, archived
  availableToTiers String?  // JSON array of tiers (null = all)
  availableToRegions String? // JSON array of regions (null = all)

  // Usage tracking
  downloadCount   Int       @default(0)
  viewCount       Int       @default(0)

  // Versioning
  version         String    @default("1.0")
  previousVersionId String?

  uploadedById    String?

  downloads       MarketingAssetDownload[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([categoryId])
  @@index([assetType])
  @@index([status])
  @@index([brand])
}

model MarketingAssetCategory {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  parentId        String?
  parent          MarketingAssetCategory?  @relation("AssetCategoryHierarchy", fields: [parentId], references: [id])
  children        MarketingAssetCategory[] @relation("AssetCategoryHierarchy")
  sortOrder       Int       @default(0)

  assets          MarketingAsset[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
}

model MarketingAssetDownload {
  id              String    @id @default(cuid())
  assetId         String
  asset           MarketingAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  dealerId        String
  dealer          Dealer    @relation(fields: [dealerId], references: [id])

  downloadedAt    DateTime  @default(now())
  ipAddress       String?

  @@index([assetId])
  @@index([userId])
  @@index([dealerId])
  @@index([downloadedAt])
}

model CampaignTemplate {
  id              String    @id @default(cuid())
  name            String
  description     String?

  templateType    String    // email, flyer, social_post, banner, signage
  category        String?   // product_launch, seasonal, promotional

  // Template content
  templateUrl     String?   // URL to template file
  previewUrl      String?   // Preview image

  // Customization options (JSON)
  customizableFields String? // JSON: [{ field, type, label, defaultValue }]

  // Availability
  status          String    @default("active") // draft, active, archived
  availableToTiers String?  // JSON array

  // Usage
  useCount        Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([templateType])
  @@index([status])
}

// ============================================================================
// 8.7 COMMUNITY FORUM
// ============================================================================

model ForumCategory {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  icon            String?   // Icon name for display
  color           String?   // Hex color for theming

  // Targeting - which roles/audiences can access
  targetAudience  String    @default("all") // all, techs, sales, marketing, admin

  // Hierarchy
  parentId        String?
  parent          ForumCategory?  @relation("ForumCategoryHierarchy", fields: [parentId], references: [id])
  children        ForumCategory[] @relation("ForumCategoryHierarchy")
  sortOrder       Int       @default(0)

  // Status
  isActive        Boolean   @default(true)

  // Stats (denormalized for performance)
  postCount       Int       @default(0)
  lastPostAt      DateTime?

  posts           ForumPost[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
  @@index([targetAudience])
  @@index([isActive])
}

model ForumPost {
  id              String    @id @default(cuid())
  categoryId      String
  category        ForumCategory @relation(fields: [categoryId], references: [id])
  authorId        String
  author          User      @relation("ForumPostAuthor", fields: [authorId], references: [id])
  dealerId        String?
  dealer          Dealer?   @relation(fields: [dealerId], references: [id])

  // Content
  title           String
  content         String    // Rich text / markdown
  excerpt         String?   // Short preview

  // Post type
  postType        String    @default("discussion") // discussion, question, announcement, tip

  // Tags for searchability (JSON array)
  tags            String?   // JSON array of tags

  // Status
  status          String    @default("published") // draft, published, hidden, locked
  isPinned        Boolean   @default(false) // Sticky post at top
  isLocked        Boolean   @default(false) // No new replies allowed
  isFeatured      Boolean   @default(false) // Featured/highlighted post

  // Question-specific (if postType = question)
  isResolved      Boolean   @default(false)
  acceptedReplyId String?   // The reply that answered the question

  // Stats (denormalized for performance)
  viewCount       Int       @default(0)
  replyCount      Int       @default(0)
  likeCount       Int       @default(0)
  lastReplyAt     DateTime?
  lastReplyById   String?

  // Moderation
  moderatedById   String?
  moderatedAt     DateTime?
  moderationReason String?

  replies         ForumReply[]
  likes           ForumPostLike[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([categoryId])
  @@index([authorId])
  @@index([dealerId])
  @@index([status])
  @@index([isPinned])
  @@index([postType])
  @@index([createdAt])
  @@index([lastReplyAt])
}

model ForumReply {
  id              String    @id @default(cuid())
  postId          String
  post            ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId        String
  author          User      @relation("ForumReplyAuthor", fields: [authorId], references: [id])
  dealerId        String?
  dealer          Dealer?   @relation(fields: [dealerId], references: [id])

  // Nested replies
  parentReplyId   String?
  parentReply     ForumReply?  @relation("ReplyThread", fields: [parentReplyId], references: [id])
  childReplies    ForumReply[] @relation("ReplyThread")

  // Content
  content         String    // Rich text / markdown

  // Status
  status          String    @default("published") // published, hidden, deleted
  isAcceptedAnswer Boolean  @default(false) // For question posts

  // Stats
  likeCount       Int       @default(0)

  // Moderation
  moderatedById   String?
  moderatedAt     DateTime?
  moderationReason String?

  // Edit tracking
  isEdited        Boolean   @default(false)
  editedAt        DateTime?

  likes           ForumReplyLike[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([dealerId])
  @@index([parentReplyId])
  @@index([status])
  @@index([createdAt])
}

model ForumPostLike {
  id              String    @id @default(cuid())
  postId          String
  post            ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  createdAt       DateTime  @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model ForumReplyLike {
  id              String    @id @default(cuid())
  replyId         String
  reply           ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  createdAt       DateTime  @default(now())

  @@unique([replyId, userId])
  @@index([replyId])
  @@index([userId])
}
